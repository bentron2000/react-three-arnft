{"version":3,"file":"arnft.js","names":["isMobile","setMatrix","workerScript","ARNft","cameraParamUrl","video","renderer","camera","onLoaded","interpolationFactor","_this","_classCallCheck","inputWidth","videoWidth","inputHeight","videoHeight","matrixAutoUpdate","markers","canvasProcess","document","createElement","contextProcess","getContext","initRenderer","worker","Worker","onmessage","e","onWorkerMessage","postMessage","type","pw","ph","_createClass","key","value","pScale","Math","max","sScale","window","outerWidth","sw","sh","w","h","ox","oy","style","clientWidth","clientHeight","width","height","console","log","setSize","loadMarkers","forEach","marker","root","map","url","process","fillStyle","fillRect","drawImage","imageData","getImageData","imagedata","data","buffer","msg","proj","JSON","parse","ratioW","ratioH","f","n","projectionMatrix","end","onMarkerInfos","onFound","onLost","markerInfos","_this2","markerInfo","id","children","position","x","dpi","y","matrix","matrixGL_RH","index","i","visible"],"sources":["../../src/arnft/arnft.js"],"sourcesContent":["/* eslint-disable camelcase */\nimport { isMobile, setMatrix } from \"./utils\"\n\nconst workerScript = \"./worker/arnft.worker.js\"\n\nexport class ARNft {\n  constructor(\n    cameraParamUrl,\n    video,\n    renderer,\n    camera,\n    onLoaded,\n    interpolationFactor,\n  ) {\n    this.inputWidth = video.videoWidth\n    this.inputHeight = video.videoHeight\n\n    this.cameraParamUrl = cameraParamUrl\n    this.video = video\n    this.renderer = renderer\n    this.camera = camera\n    this.onLoaded = onLoaded\n\n    this.camera.matrixAutoUpdate = false\n\n    this.markers = []\n\n    this.canvasProcess = document.createElement(\"canvas\")\n    this.contextProcess = this.canvasProcess.getContext(\"2d\")\n\n    this.initRenderer()\n\n    this.worker = new Worker(workerScript)\n    this.worker.onmessage = (e) => this.onWorkerMessage(e)\n    this.worker.postMessage({\n      type: \"load\",\n      pw: this.pw,\n      ph: this.ph,\n      cameraParamUrl: this.cameraParamUrl,\n      interpolationFactor,\n    })\n  }\n\n  initRenderer() {\n    const pScale = 320 / Math.max(this.inputWidth, (this.inputHeight / 3) * 4)\n    const sScale = isMobile() ? window.outerWidth / this.inputWidth : 1\n\n    const sw = this.inputWidth * sScale\n    const sh = this.inputHeight * sScale\n\n    this.w = this.inputWidth * pScale\n    this.h = this.inputHeight * pScale\n\n    this.pw = Math.max(this.w, (this.h / 3) * 4)\n    this.ph = Math.max(this.h, (this.w / 4) * 3)\n\n    this.ox = (this.pw - this.w) / 2\n    this.oy = (this.ph - this.h) / 2\n\n    this.canvasProcess.style.clientWidth = this.pw + \"px\"\n    this.canvasProcess.style.clientHeight = this.ph + \"px\"\n    this.canvasProcess.width = this.pw\n    this.canvasProcess.height = this.ph\n\n    console.log(\n      \"processCanvas:\",\n      this.canvasProcess.width,\n      this.canvasProcess.height,\n    )\n\n    this.renderer.setSize(sw, sh, false) // false -> do not update css styles\n  }\n\n  loadMarkers(markers) {\n    markers.forEach((marker) => (marker.root.matrixAutoUpdate = false))\n\n    this.markers = markers\n    this.worker.postMessage({\n      type: \"loadMarkers\",\n      markers: markers.map((marker) => marker.url),\n    })\n  }\n\n  process() {\n    this.contextProcess.fillStyle = \"black\"\n    this.contextProcess.fillRect(0, 0, this.pw, this.ph)\n    this.contextProcess.drawImage(\n      this.video,\n      0,\n      0,\n      this.inputWidth,\n      this.inputHeight,\n      this.ox,\n      this.oy,\n      this.w,\n      this.h,\n    )\n\n    const imageData = this.contextProcess.getImageData(0, 0, this.pw, this.ph)\n    this.worker.postMessage({ type: \"process\", imagedata: imageData }, [\n      imageData.data.buffer,\n    ])\n  }\n\n  onWorkerMessage(e) {\n    const msg = e.data\n    switch (msg.type) {\n      case \"loaded\": {\n        const proj = JSON.parse(msg.proj)\n        const ratioW = this.pw / this.w\n        const ratioH = this.ph / this.h\n        const f = 2000.0\n        const n = 0.1\n\n        proj[0] *= ratioW\n        proj[5] *= ratioH\n        proj[10] = -(f / (f - n))\n        proj[14] = -((f * n) / (f - n))\n\n        setMatrix(this.camera.projectionMatrix, proj)\n\n        this.onLoaded(msg)\n        break\n      }\n      case \"markersLoaded\": {\n        if (msg.end === true) {\n          console.log(msg)\n        }\n        this.process()\n        break\n      }\n      case \"markerInfos\": {\n        this.onMarkerInfos(msg.markers)\n        break\n      }\n      case \"found\": {\n        console.log(\"found\", msg)\n        this.onFound(msg)\n        break\n      }\n      case \"lost\": {\n        console.log(\"lost\", msg)\n        this.onLost(msg)\n        break\n      }\n      case \"processNext\": {\n        this.process()\n        break\n      }\n    }\n  }\n\n  onMarkerInfos(markerInfos) {\n    console.log(\"markerInfos\", markerInfos)\n    markerInfos.forEach((markerInfo) => {\n      this.markers[markerInfo.id].root.children[0].position.x =\n        ((markerInfo.width / markerInfo.dpi) * 2.54 * 10) / 2.0\n      this.markers[markerInfo.id].root.children[0].position.y =\n        ((markerInfo.height / markerInfo.dpi) * 2.54 * 10) / 2.0\n    })\n  }\n\n  onFound(msg) {\n    const matrix = JSON.parse(msg.matrixGL_RH)\n    const index = JSON.parse(msg.index)\n\n    setMatrix(this.markers[index].root.matrix, matrix)\n\n    this.markers.forEach((marker, i) => {\n      marker.root.visible = i === index\n    })\n  }\n\n  onLost(msg) {\n    this.markers.forEach((marker) => {\n      marker.root.visible = false\n    })\n  }\n}\n"],"mappings":"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","ignoreList":[]}
{"version":3,"file":"arnft.js","names":["isMobile","setMatrix","workerScript","ARNft","cameraParamUrl","video","renderer","camera","onLoaded","interpolationFactor","_this","_classCallCheck","inputWidth","videoWidth","inputHeight","videoHeight","matrixAutoUpdate","markers","canvasProcess","document","createElement","contextProcess","getContext","initRenderer","worker","Worker","URL","import","meta","url","onmessage","e","onWorkerMessage","postMessage","type","pw","ph","_createClass","key","value","pScale","Math","max","sScale","window","outerWidth","sw","sh","w","h","ox","oy","style","clientWidth","clientHeight","width","height","console","log","setSize","loadMarkers","forEach","marker","root","map","process","fillStyle","fillRect","drawImage","imageData","getImageData","imagedata","data","buffer","msg","proj","JSON","parse","ratioW","ratioH","f","n","projectionMatrix","end","onMarkerInfos","onFound","onLost","markerInfos","_this2","markerInfo","id","children","position","x","dpi","y","matrix","matrixGL_RH","index","i","visible"],"sources":["../../src/arnft/arnft.js"],"sourcesContent":["/* eslint-disable camelcase */\nimport { isMobile, setMatrix } from \"./utils\"\n\nconst workerScript = \"./worker/arnft.worker.js\"\n\nexport class ARNft {\n  constructor(\n    cameraParamUrl,\n    video,\n    renderer,\n    camera,\n    onLoaded,\n    interpolationFactor,\n  ) {\n    this.inputWidth = video.videoWidth\n    this.inputHeight = video.videoHeight\n\n    this.cameraParamUrl = cameraParamUrl\n    this.video = video\n    this.renderer = renderer\n    this.camera = camera\n    this.onLoaded = onLoaded\n\n    this.camera.matrixAutoUpdate = false\n\n    this.markers = []\n\n    this.canvasProcess = document.createElement(\"canvas\")\n    this.contextProcess = this.canvasProcess.getContext(\"2d\")\n\n    this.initRenderer()\n\n    this.worker = new Worker(new URL(workerScript, import.meta.url))\n    this.worker.onmessage = (e) => this.onWorkerMessage(e)\n    this.worker.postMessage({\n      type: \"load\",\n      pw: this.pw,\n      ph: this.ph,\n      cameraParamUrl: this.cameraParamUrl,\n      interpolationFactor,\n    })\n  }\n\n  initRenderer() {\n    const pScale = 320 / Math.max(this.inputWidth, (this.inputHeight / 3) * 4)\n    const sScale = isMobile() ? window.outerWidth / this.inputWidth : 1\n\n    const sw = this.inputWidth * sScale\n    const sh = this.inputHeight * sScale\n\n    this.w = this.inputWidth * pScale\n    this.h = this.inputHeight * pScale\n\n    this.pw = Math.max(this.w, (this.h / 3) * 4)\n    this.ph = Math.max(this.h, (this.w / 4) * 3)\n\n    this.ox = (this.pw - this.w) / 2\n    this.oy = (this.ph - this.h) / 2\n\n    this.canvasProcess.style.clientWidth = this.pw + \"px\"\n    this.canvasProcess.style.clientHeight = this.ph + \"px\"\n    this.canvasProcess.width = this.pw\n    this.canvasProcess.height = this.ph\n\n    console.log(\n      \"processCanvas:\",\n      this.canvasProcess.width,\n      this.canvasProcess.height,\n    )\n\n    this.renderer.setSize(sw, sh, false) // false -> do not update css styles\n  }\n\n  loadMarkers(markers) {\n    markers.forEach((marker) => (marker.root.matrixAutoUpdate = false))\n\n    this.markers = markers\n    this.worker.postMessage({\n      type: \"loadMarkers\",\n      markers: markers.map((marker) => marker.url),\n    })\n  }\n\n  process() {\n    this.contextProcess.fillStyle = \"black\"\n    this.contextProcess.fillRect(0, 0, this.pw, this.ph)\n    this.contextProcess.drawImage(\n      this.video,\n      0,\n      0,\n      this.inputWidth,\n      this.inputHeight,\n      this.ox,\n      this.oy,\n      this.w,\n      this.h,\n    )\n\n    const imageData = this.contextProcess.getImageData(0, 0, this.pw, this.ph)\n    this.worker.postMessage({ type: \"process\", imagedata: imageData }, [\n      imageData.data.buffer,\n    ])\n  }\n\n  onWorkerMessage(e) {\n    const msg = e.data\n    switch (msg.type) {\n      case \"loaded\": {\n        const proj = JSON.parse(msg.proj)\n        const ratioW = this.pw / this.w\n        const ratioH = this.ph / this.h\n        const f = 2000.0\n        const n = 0.1\n\n        proj[0] *= ratioW\n        proj[5] *= ratioH\n        proj[10] = -(f / (f - n))\n        proj[14] = -((f * n) / (f - n))\n\n        setMatrix(this.camera.projectionMatrix, proj)\n\n        this.onLoaded(msg)\n        break\n      }\n      case \"markersLoaded\": {\n        if (msg.end === true) {\n          console.log(msg)\n        }\n        this.process()\n        break\n      }\n      case \"markerInfos\": {\n        this.onMarkerInfos(msg.markers)\n        break\n      }\n      case \"found\": {\n        console.log(\"found\", msg)\n        this.onFound(msg)\n        break\n      }\n      case \"lost\": {\n        console.log(\"lost\", msg)\n        this.onLost(msg)\n        break\n      }\n      case \"processNext\": {\n        this.process()\n        break\n      }\n    }\n  }\n\n  onMarkerInfos(markerInfos) {\n    console.log(\"markerInfos\", markerInfos)\n    markerInfos.forEach((markerInfo) => {\n      this.markers[markerInfo.id].root.children[0].position.x =\n        ((markerInfo.width / markerInfo.dpi) * 2.54 * 10) / 2.0\n      this.markers[markerInfo.id].root.children[0].position.y =\n        ((markerInfo.height / markerInfo.dpi) * 2.54 * 10) / 2.0\n    })\n  }\n\n  onFound(msg) {\n    const matrix = JSON.parse(msg.matrixGL_RH)\n    const index = JSON.parse(msg.index)\n\n    setMatrix(this.markers[index].root.matrix, matrix)\n\n    this.markers.forEach((marker, i) => {\n      marker.root.visible = i === index\n    })\n  }\n\n  onLost(msg) {\n    this.markers.forEach((marker) => {\n      marker.root.visible = false\n    })\n  }\n}\n"],"mappings":"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","ignoreList":[]}